
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>Reviderm · Ventas</title>
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#7c003d">
  <link rel="apple-touch-icon" href="assets/icon-192.png">
  <style>
    :root{
      --bg:#f7f7f7; --fg:#111; --muted:#666; --card:#fff; --border:#e5e5e5;
      --berry:#7c003d; --brand:#7c003d; --primary:#7c003d; --gray:#9ca3af;
      --ok:#16a34a; --ok-bright:#22c55e;
    }
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    .container{max-width:1024px;margin:0 auto;padding:16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 1px 8px rgba(0,0,0,.04)}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .btn{display:inline-flex;align-items:center;justify-content:center;padding:12px 16px;border-radius:12px;border:1px solid var(--border);background:var(--brand);color:#fff;font-weight:600;cursor:pointer}
    .btn:active{transform:translateY(1px)}
    .btn.tab{background:#fff;color:#111}
    .btn.full{width:100%}
    .btn.small{padding:8px 12px;font-weight:500}
    .btn.add{background:var(--brand);color:#fff;border-color:var(--brand)}
    .btn.remove{background:var(--brand);color:#fff;border-color:var(--brand)}
    .btn.logout{background:var(--brand);color:#fff;border-color:var(--brand)}
    .tabs .btn.active{background:var(--berry);color:#fff;border-color:var(--berry)}
    .input,select{padding:12px;border:1px solid var(--border);border-radius:12px;width:100%;font-size:16px}
    .label{font-size:12px;color:var(--muted);margin-bottom:4px}
    .grid{display:grid;gap:12px}
    .grid-2{grid-template-columns:1fr 1fr}
    .grid-3{grid-template-columns:repeat(3,1fr)}
    .small{font-size:12px;color:var(--muted)}
    .title{font-size:18px;font-weight:700}
    .subtitle{font-size:14px;color:var(--muted)}
    .list{display:grid;gap:8px}
    .pill{border:1px solid var(--border);padding:6px 10px;border-radius:999px;font-size:12px;color:#111;background:#fff}
    .progress{height:12px;background:#e5e5e5;border-radius:999px;overflow:hidden}
    .progress>div{height:100%;background:var(--berry);width:0;transition:width .3s ease}
    header{position:sticky;top:0;background:rgba(255,255,255,.9);backdrop-filter:saturate(180%) blur(8px);border-bottom:1px solid var(--border);z-index:10}
    header .container{display:flex;align-items:center;justify-content:space-between}
    .hidden{display:none}
    footer{padding:24px 0;color:var(--muted);text-align:center;font-size:12px}
    .reward{position:relative;border:1px solid var(--border);padding:10px;border-radius:12px;display:flex;align-items:center;justify-content:space-between}
    .reward.past{background:#f3f4f6;border-color:#e5e7eb;color:#6b7280}
    .reward.current{background:#ecfdf5;border:4px solid var(--ok-bright);box-shadow:0 0 0 6px rgba(34,197,94,.18)}
    .reward.current::after{content:"Aquí estás";position:absolute;top:-10px;right:-10px;background:var(--ok-bright);color:#fff;padding:2px 8px;border-radius:999px;font-size:12px;font-weight:800}
    .reward.future{background:#fff;border-color:var(--border)}
    #rewards-next{font-size:22px;font-weight:900;color:var(--berry)}
  </style>
</head>
<body>
  <header>
    <div class="container">
      <div class="title">Reviderm · Ventas diarias</div>
      <button id="btn-logout" class="btn small hidden logout">Salir</button>
    </div>
  </header>

  <main class="container">
    <section id="screen-login" class="card" style="padding:16px;">
      <div class="grid">
        <div class="title">Ingresar</div>
        <div class="grid grid-3">
          <div>
            <div class="label">Región</div>
            <select id="login-region" class="input"></select>
          </div>
          <div>
            <div class="label">Local</div>
            <select id="login-local" class="input" disabled></select>
          </div>
          <div>
            <div class="label">Asesora</div>
            <select id="login-advisor" class="input" disabled></select>
          </div>
        </div>
        <div>
          <div class="label">DNI (contraseña)</div>
          <input type="password" id="login-dni" class="input" placeholder="Ingresa tu DNI" inputmode="numeric" pattern="[0-9]*" oninput="this.value=this.value.replace(/\D+/g,'')">
        </div>
        <button id="btn-login" class="btn full">Entrar</button>
        <div class="small">Solo dígitos en el DNI (sin puntos ni guiones).</div>
      </div>
    </section>

    <section id="screen-app" class="hidden">
      <div class="row">
        <div style="flex:2;min-width:320px" class="grid">
          <div class="card" style="padding:16px">
            <div class="row" style="justify-content:space-between">
              <div>
                <div class="title">Registrar venta</div>
                <div class="subtitle" id="store-badge"></div>
              </div>
              <div>
                <input id="search" class="input" placeholder="Buscar por nombre o SKU" oninput="renderProductButtons()">
              </div>
            </div>

            <div class="grid" style="margin-top:12px">
              <div class="title" style="font-size:16px">Categorías</div>
              <div id="cat-buttons" class="tabs"></div>
              <div id="subcat-buttons" class="tabs"></div>
              <div id="product-buttons" class="row" style="gap:8px;align-items:stretch"></div>
            </div>

            <div class="card" style="padding:12px;margin-top:12px;border-style:dashed">
              <div class="row" style="justify-content:space-between;align-items:center;">
                <div class="title" style="font-size:16px">Pendiente de enviar</div>
                <div class="subtitle" id="cart-count">0 ítems</div>
              </div>
              <div id="cart-list" class="list" style="margin-top:8px"></div>
              <div class="row" style="justify-content:space-between;align-items:center;margin-top:8px">
                <div class="title" style="font-size:16px">Total</div>
                <div id="cart-total" class="title" style="font-size:18px">S/ 0.00</div>
              </div>
              <button id="btn-submit" class="btn full">Enviar venta</button>
            </div>

            <div id="history" class="grid" style="margin-top:12px"></div>
          </div>
        </div>

        <div style="flex:1;min-width:260px" class="grid">
          <div class="card" style="padding:16px">
            <div class="title">Objetivo mes</div>
            <div class="subtitle" id="goal-label"></div>
            <div class="progress" style="margin-top:8px"><div id="progress-bar"></div></div>
            <div class="subtitle" id="progress-text" style="margin-top:8px"></div>
          </div>

          <div class="card" style="padding:16px">
            <div class="title">Premios del mes (S/)</div>
            <div id="rewards-list" class="list" style="margin-top:8px"></div>
            <div id="rewards-next" class="subtitle" style="margin-top:8px"></div>
          </div>

        </div>
      </div>
    </section>
  </main>

  <footer>Reviderm · MVP v7.4.1 (fix &lt;b&gt;und.&lt;/b&gt; en recompensas) · offline</footer>

  <script>
   <script>
/* === Reviderm PWA v7.5 (frontend conectado a backend) ===
   Cambios clave:
   - Login llama a /.netlify/functions/login  → devuelve advisorId
   - Enviar venta llama a /.netlify/functions/sale
   - Progreso del mes llama a /.netlify/functions/progress (servidor)
   Mantiene el historial local como respaldo (offline).
*/

const API = '/.netlify/functions';

// Estas constantes ya existen en tu HTML de v7.x.
// Si tu index.html las trae embebidas, las usamos tal cual:
const PRODUCTS = typeof PRODUCTS !== 'undefined' ? PRODUCTS : [];
const CATEGORY_TREE = typeof CATEGORY_TREE !== 'undefined' ? CATEGORY_TREE : {};
const REGIONS = typeof REGIONS !== 'undefined' ? REGIONS : [];

let STATE = { user: null, cart: [], history: [] };

// Utilidades
const S = sel => document.querySelector(sel);
const fmt = n => new Intl.NumberFormat("es-PE",{ style:"currency", currency:"PEN" }).format(n||0);
const monthKey = () => new Date().toISOString().slice(0,7);
const onlyDigits = s => (s||"").replace(/\D+/g, "");
const esc = s => (s||"").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
const weightForCategory = (cat="") => /intelligence/i.test(cat) ? 2 : 1;

// ------------------ LOGIN ------------------
function initLogin(){
  // Poblar selects de Región/Local/Asesora
  const selRegion = S("#login-region");
  const selLocal  = S("#login-local");
  const selAdv    = S("#login-advisor");

  selRegion.innerHTML = '<option value="">Selecciona...</option>' + REGIONS.map(r => `<option value="${r.id}">${r.name}</option>`).join("");
  selLocal.disabled = true; selAdv.disabled = true;

  selRegion.onchange = () => {
    const r = REGIONS.find(x=> x.id===selRegion.value);
    if(!r){ selLocal.disabled = true; selAdv.disabled = true; return; }
    selLocal.disabled = false;
    selLocal.innerHTML = '<option value="">Selecciona...</option>' + r.locales.map(l => `<option value="${l.id}">${l.name}</option>`).join("");
    selAdv.disabled = true; selAdv.innerHTML = '<option value="">Selecciona...</option>';
  };
  selLocal.onchange = () => {
    const r = REGIONS.find(x=> x.id===selRegion.value);
    const l = r ? r.locales.find(x=> x.id===selLocal.value) : null;
    if(!l){ selAdv.disabled = true; return; }
    selAdv.disabled = false;
    selAdv.innerHTML = '<option value="">Selecciona...</option>' + l.advisors.map(a => `<option value="${a.id}">${a.name}</option>`).join("");
  };

  S("#btn-login").onclick = async () => {
    const rId = S("#login-region").value;
    const lId = S("#login-local").value;
    const aId = S("#login-advisor").value;
    const dni = onlyDigits(S("#login-dni").value);

    if(!rId || !lId || !aId) { alert("Selecciona región, local y asesora"); return; }
    if(!dni) { alert("Ingresa tu DNI (solo dígitos)"); return; }

    const r = REGIONS.find(x=>x.id===rId);
    const l = r.locales.find(x=>x.id===lId);
    const a = l.advisors.find(x=>x.id===aId);

    // Login en servidor (valida DNI contra Neon)
    let resp;
    try{
      resp = await fetch(`${API}/login`, {
        method:'POST',
        headers:{'content-type':'application/json'},
        body: JSON.stringify({ region: r.name, local: l.name, advisor: a.name, dni })
      }).then(x=>x.json());
    }catch(e){
      alert("No se pudo conectar con el servidor. Revisa tu conexión.");
      return;
    }
    if(!resp || !resp.ok){ alert("DNI o datos incorrectos"); return; }

    STATE.user = {
      regionId:r.id, regionName:r.name,
      localId:l.id,  localName:l.name,
      advisorId: resp.advisorId, advisorName: a.name,
      dni
    };
    localStorage.setItem("reviderm_user", JSON.stringify(STATE.user));
    enterApp();
  };
}

function enterApp(){
  S("#screen-login").classList.add("hidden");
  S("#screen-app").classList.remove("hidden");
  S("#btn-logout").classList.remove("hidden");
  S("#store-badge").textContent = `${STATE.user.regionName} · ${STATE.user.localName} · ${STATE.user.advisorName}`;

  // Cargar historial local (respaldo offline)
  const histKey = "reviderm_history_"+(STATE.user.dni||STATE.user.advisorId)+"_"+monthKey();
  try{ STATE.history = JSON.parse(localStorage.getItem(histKey)) || []; } catch{ STATE.history = []; }

  renderAll();
}
function logout(){ STATE.user=null; localStorage.removeItem("reviderm_user"); location.reload(); }

// ------------------ CATEGORÍAS/PRODUCTOS ------------------
let CURRENT_CAT = null, CURRENT_SUBCAT = null;

function renderCategories(){
  const cats = Object.keys(CATEGORY_TREE).sort();
  const cont = S("#cat-buttons");
  cont.innerHTML = cats.map(c => `<button class="btn tab ${c===CURRENT_CAT?'active':''}" onclick="selectCat('${c.replace(/'/g,"\\'")}')">${c}</button>`).join("");
  if(!CURRENT_CAT && cats.length) CURRENT_CAT = cats[0];
  renderSubcategories();
}
function selectCat(cat){ CURRENT_CAT = cat; CURRENT_SUBCAT = null; renderCategories(); }
function renderSubcategories(){
  const subs = Object.keys(CATEGORY_TREE[CURRENT_CAT] || {}).sort();
  const cont = S("#subcat-buttons");
  cont.innerHTML = subs.map(s => `<button class="btn tab ${s===CURRENT_SUBCAT?'active':''}" onclick="selectSubcat('${s.replace(/'/g,"\\'")}')">${s}</button>`).join("");
  if(!CURRENT_SUBCAT && subs.length) CURRENT_SUBCAT = subs[0];
  renderProductButtons();
}
function selectSubcat(sub){ CURRENT_SUBCAT = sub; renderSubcategories(); }

function renderProductButtons(){
  const q = (S("#search").value||"").toLowerCase().trim();
  let prods = [];
  if(q){
    prods = PRODUCTS.filter(p => (p.name+" "+(p.sku||"")).toLowerCase().includes(q));
  } else {
    const ids = (CATEGORY_TREE[CURRENT_CAT]||{})[CURRENT_SUBCAT] || [];
    prods = PRODUCTS.filter(p => ids.includes(p.id));
  }
  const cont = S("#product-buttons");
  if(prods.length===0){ cont.innerHTML = '<div class="small">Sin resultados.</div>'; return; }
  cont.innerHTML = prods.map(p => {
    const price = (p.price!=null? fmt(p.price): "S/ —");
    return `
      <div class="card" style="padding:10px;min-width:220px;flex:1">
        <div style="font-weight:700">${p.name}</div>
        <div class="small">SKU ${p.sku||"-"}</div>
        <div class="pill" style="margin-top:6px;display:inline-block">${price}</div>
        <div class="row" style="margin-top:8px;gap:6px;align-items:center">
          <button class="btn small tab" onclick="decQty('${p.id}')">−</button>
          <span id="qty-${p.id}" class="pill">0</span>
          <button class="btn small tab" onclick="incQty('${p.id}')">+</button>
          <button class="btn small add" style="margin-left:8px" onclick="addQtyToCart('${p.id}')">Añadir</button>
        </div>
      </div>`;
  }).join("");
}
const qtyBuffer = new Map();
function incQty(pid){ qtyBuffer.set(pid, (qtyBuffer.get(pid)||0)+1); S('#qty-'+pid).textContent = qtyBuffer.get(pid); }
function decQty(pid){ const v=(qtyBuffer.get(pid)||0)-1; qtyBuffer.set(pid, Math.max(0,v)); S('#qty-'+pid).textContent = qtyBuffer.get(pid); }

// ------------------ CARRITO / ENVÍO ------------------
function addQtyToCart(pid){
  const qty = qtyBuffer.get(pid)||0; if(qty<=0) return;
  const p = PRODUCTS.find(x=> x.id===pid);
  const idx = STATE.cart.findIndex(l => l.productId === pid);
  const price = p && p.price ? p.price : 0;
  if(idx>=0) STATE.cart[idx].qty += qty;
  else STATE.cart.push({ productId: pid, qty, price });
  qtyBuffer.set(pid,0); S('#qty-'+pid).textContent = 0;
  renderCart();
}
function removeLine(i){ STATE.cart.splice(i,1); renderCart(); }

async function submitSale(){
  if(STATE.cart.length===0){ alert("No hay productos en el carrito"); return; }
  if(!STATE.user?.advisorId){ alert("Vuelve a iniciar sesión"); return; }

  const payload = {
    advisorId: STATE.user.advisorId,
    region: STATE.user.regionName,
    local:  STATE.user.localName,
    date:   new Date().toISOString().slice(0,10),
    items:  STATE.cart.map(l => ({ productId: l.productId, qty: l.qty }))
  };

  // 1) Intentar guardar en la nube (Neon) vía Function
  let okCloud = false, saleId = null;
  try{
    const r = await fetch(`${API}/sale`, {
      method:'POST',
      headers:{'content-type':'application/json'},
      body: JSON.stringify(payload)
    }).then(x=>x.json());
    okCloud = !!(r && r.ok);
    saleId = r?.saleId || null;
  }catch(e){ okCloud = false; }

  // 2) Mantener histórico local (respaldo offline)
  const histKey = "reviderm_history_"+(STATE.user.dni||STATE.user.advisorId)+"_"+monthKey();
  STATE.history.push({
    id: saleId || crypto.randomUUID(),
    date: payload.date,
    items: STATE.cart.map(x => ({...x})),
    totalUnits: STATE.cart.reduce((a,l)=>a+l.qty,0),
    totalAmount: STATE.cart.reduce((a,l)=>a+l.qty*(l.price||0),0)
  });
  localStorage.setItem(histKey, JSON.stringify(STATE.history));
  STATE.cart = [];
  renderAll();

  alert(okCloud ? "Venta registrada (nube + local)" : "Venta registrada localmente (sin conexión). Se intentará sincronizar luego.");
}

function renderCart(){
  S("#cart-count").textContent = STATE.cart.length + " ítems";
  const list = S("#cart-list");
  if(STATE.cart.length===0){ list.innerHTML = '<div class="small">Añade productos para registrar la venta de hoy.</div>'; S("#cart-total").textContent = fmt(0); return; }
  list.innerHTML = STATE.cart.map((l,i)=>{
    const p = PRODUCTS.find(x=>x.id===l.productId);
    return `
      <div class="row card" style="padding:8px;align-items:center;justify-content:space-between">
        <div>
          <div style="font-weight:600)">${p?p.name:"?"}</div>
          <div class="small">SKU ${p?p.sku:""} · ${l.qty} <b>und.</b> · ${l.price?fmt(l.price):"S/ —"}</div>
        </div>
        <button class="btn small remove" onclick="removeLine(${i})">Quitar</button>
      </div>`;
  }).join("");
  const total = STATE.cart.reduce((a,l)=>a+l.qty*(l.price||0),0);
  S("#cart-total").textContent = fmt(total);
}

function renderHistory(){
  const cont = S("#history");
  if(STATE.history.length===0){ cont.innerHTML = ""; return; }
  cont.innerHTML = '<div class="title" style="font-size:16px">Historial reciente</div>' +
    STATE.history.slice().reverse().slice(0,5).map(h=>{
      return `
        <div class="row card" style="padding:8px;align-items:center;justify-content:space-between">
          <div>
            <div style="font-weight:600)">${h.date}</div>
            <div class="small">${h.items.length} líneas · ${h.totalUnits} <b>und.</b> · ${fmt(h.totalAmount)}</div>
          </div>
          <div class="pill" style="background:#ecfdf5;border-color:#bbf7d0;color:#065f46">✓ registrado</div>
        </div>`;
    }).join("");
}

// ------------------ PROGRESO (ahora desde el SERVIDOR) ------------------
async function renderProgress(){
  const goalLbl = S("#goal-label");
  const bar = S("#progress-bar");
  const ptxt = S("#progress-text");
  const rewardsList = S("#rewards-list");
  const nextLbl = S("#rewards-next");

  const month = monthKey();
  let units = 0, goal = 0, rewards = [];

  if(STATE.user?.advisorId){
    try{
      const q = new URLSearchParams({ advisorId: STATE.user.advisorId, month }).toString();
      const r = await fetch(`${API}/progress?${q}`).then(x=>x.json());
      if(r && r.ok){
        units = Number(r.unitsWeighted||0);
        goal  = Number(r.goal||0);
        rewards = r.rewards || [];
      }
    }catch(e){ /* fallback abajo */ }
  }

  // Fallback simple si no hay server: usa historial local
  if(!goal && !rewards.length){
    // Mantén meta por defecto si no tienes objetivos en servidor
    goal = 100;
  }

  const pct = goal ? Math.max(0, Math.min(100, Math.round((units/goal)*100))) : 0;
  goalLbl.textContent = `Objetivo mes: ${goal||0} unidades ponderadas`;
  bar.style.width = pct + "%";
  ptxt.textContent = `Llevas ${units} unidades ponderadas (${pct}%).`;

  // Pintar premios (usa estado que viene del servidor: past/current/future)
  rewardsList.innerHTML = (rewards.length? rewards : []).map(r=>{
    const money = r.value_pen!=null ? ' · '+new Intl.NumberFormat("es-PE",{style:"currency",currency:"PEN"}).format(r.value_pen) : '';
    const state = r.state || (units >= r.threshold ? 'past' : 'future');
    const cls = state==='current' ? 'reward current' : (state==='past' ? 'reward past' : 'reward future');
    return `<div class="${cls}"><div>${esc(r.label)}${money}</div><div class="small">${r.threshold} <b>und.</b></div></div>`;
  }).join("");

  // Mensaje "Te faltan…"
  let next = null;
  for(const r of (rewards || [])){ if(units < r.threshold){ next = r; break; } }
  if(next){
    nextLbl.innerHTML = `Te faltan ${(next.threshold-units)} <b>und.</b> para ${esc(next.label)}.`;
  }else{
    nextLbl.textContent = rewards.length ? "¡Alcanzaste el máximo nivel este mes!" : "";
  }
}

// ------------------ RENDER GENERAL ------------------
function renderAll(){ renderCategories(); renderProductButtons(); renderCart(); renderHistory(); renderProgress(); }

// ------------------ ARRANQUE ------------------
window.addEventListener("load", ()=>{
  if("serviceWorker" in navigator){ navigator.serviceWorker.register("./sw.js"); }
  initLogin();
  S("#btn-logout").onclick = logout;
  S(
  </script>
</body>
</html>

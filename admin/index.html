<script>
/* === Reviderm PWA v7.5 (frontend conectado a backend) ===
   Cambios clave:
   - Login llama a /.netlify/functions/login  → devuelve advisorId
   - Enviar venta llama a /.netlify/functions/sale
   - Progreso del mes llama a /.netlify/functions/progress (servidor)
   Mantiene el historial local como respaldo (offline).
*/

const API = '/.netlify/functions';

// Estas constantes ya existen en tu HTML de v7.x.
// Si tu index.html las trae embebidas, las usamos tal cual:
const PRODUCTS = typeof PRODUCTS !== 'undefined' ? PRODUCTS : [];
const CATEGORY_TREE = typeof CATEGORY_TREE !== 'undefined' ? CATEGORY_TREE : {};
const REGIONS = typeof REGIONS !== 'undefined' ? REGIONS : [];

let STATE = { user: null, cart: [], history: [] };

// Utilidades
const S = sel => document.querySelector(sel);
const fmt = n => new Intl.NumberFormat("es-PE",{ style:"currency", currency:"PEN" }).format(n||0);
const monthKey = () => new Date().toISOString().slice(0,7);
const onlyDigits = s => (s||"").replace(/\D+/g, "");
const esc = s => (s||"").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
const weightForCategory = (cat="") => /intelligence/i.test(cat) ? 2 : 1;

// ------------------ LOGIN ------------------
function initLogin(){
  // Poblar selects de Región/Local/Asesora
  const selRegion = S("#login-region");
  const selLocal  = S("#login-local");
  const selAdv    = S("#login-advisor");

  selRegion.innerHTML = '<option value="">Selecciona...</option>' + REGIONS.map(r => `<option value="${r.id}">${r.name}</option>`).join("");
  selLocal.disabled = true; selAdv.disabled = true;

  selRegion.onchange = () => {
    const r = REGIONS.find(x=> x.id===selRegion.value);
    if(!r){ selLocal.disabled = true; selAdv.disabled = true; return; }
    selLocal.disabled = false;
    selLocal.innerHTML = '<option value="">Selecciona...</option>' + r.locales.map(l => `<option value="${l.id}">${l.name}</option>`).join("");
    selAdv.disabled = true; selAdv.innerHTML = '<option value="">Selecciona...</option>';
  };
  selLocal.onchange = () => {
    const r = REGIONS.find(x=> x.id===selRegion.value);
    const l = r ? r.locales.find(x=> x.id===selLocal.value) : null;
    if(!l){ selAdv.disabled = true; return; }
    selAdv.disabled = false;
    selAdv.innerHTML = '<option value="">Selecciona...</option>' + l.advisors.map(a => `<option value="${a.id}">${a.name}</option>`).join("");
  };

  S("#btn-login").onclick = async () => {
    const rId = S("#login-region").value;
    const lId = S("#login-local").value;
    const aId = S("#login-advisor").value;
    const dni = onlyDigits(S("#login-dni").value);

    if(!rId || !lId || !aId) { alert("Selecciona región, local y asesora"); return; }
    if(!dni) { alert("Ingresa tu DNI (solo dígitos)"); return; }

    const r = REGIONS.find(x=>x.id===rId);
    const l = r.locales.find(x=>x.id===lId);
    const a = l.advisors.find(x=>x.id===aId);

    // Login en servidor (valida DNI contra Neon)
    let resp;
    try{
      resp = await fetch(`${API}/login`, {
        method:'POST',
        headers:{'content-type':'application/json'},
        body: JSON.stringify({ region: r.name, local: l.name, advisor: a.name, dni })
      }).then(x=>x.json());
    }catch(e){
      alert("No se pudo conectar con el servidor. Revisa tu conexión.");
      return;
    }
    if(!resp || !resp.ok){ alert("DNI o datos incorrectos"); return; }

    STATE.user = {
      regionId:r.id, regionName:r.name,
      localId:l.id,  localName:l.name,
      advisorId: resp.advisorId, advisorName: a.name,
      dni
    };
    localStorage.setItem("reviderm_user", JSON.stringify(STATE.user));
    enterApp();
  };
}

function enterApp(){
  S("#screen-login").classList.add("hidden");
  S("#screen-app").classList.remove("hidden");
  S("#btn-logout").classList.remove("hidden");
  S("#store-badge").textContent = `${STATE.user.regionName} · ${STATE.user.localName} · ${STATE.user.advisorName}`;

  // Cargar historial local (respaldo offline)
  const histKey = "reviderm_history_"+(STATE.user.dni||STATE.user.advisorId)+"_"+monthKey();
  try{ STATE.history = JSON.parse(localStorage.getItem(histKey)) || []; } catch{ STATE.history = []; }

  renderAll();
}
function logout(){ STATE.user=null; localStorage.removeItem("reviderm_user"); location.reload(); }

// ------------------ CATEGORÍAS/PRODUCTOS ------------------
let CURRENT_CAT = null, CURRENT_SUBCAT = null;

function renderCategories(){
  const cats = Object.keys(CATEGORY_TREE).sort();
  const cont = S("#cat-buttons");
  cont.innerHTML = cats.map(c => `<button class="btn tab ${c===CURRENT_CAT?'active':''}" onclick="selectCat('${c.replace(/'/g,"\\'")}')">${c}</button>`).join("");
  if(!CURRENT_CAT && cats.length) CURRENT_CAT = cats[0];
  renderSubcategories();
}
function selectCat(cat){ CURRENT_CAT = cat; CURRENT_SUBCAT = null; renderCategories(); }
function renderSubcategories(){
  const subs = Object.keys(CATEGORY_TREE[CURRENT_CAT] || {}).sort();
  const cont = S("#subcat-buttons");
  cont.innerHTML = subs.map(s => `<button class="btn tab ${s===CURRENT_SUBCAT?'active':''}" onclick="selectSubcat('${s.replace(/'/g,"\\'")}')">${s}</button>`).join("");
  if(!CURRENT_SUBCAT && subs.length) CURRENT_SUBCAT = subs[0];
  renderProductButtons();
}
function selectSubcat(sub){ CURRENT_SUBCAT = sub; renderSubcategories(); }

function renderProductButtons(){
  const q = (S("#search").value||"").toLowerCase().trim();
  let prods = [];
  if(q){
    prods = PRODUCTS.filter(p => (p.name+" "+(p.sku||"")).toLowerCase().includes(q));
  } else {
    const ids = (CATEGORY_TREE[CURRENT_CAT]||{})[CURRENT_SUBCAT] || [];
    prods = PRODUCTS.filter(p => ids.includes(p.id));
  }
  const cont = S("#product-buttons");
  if(prods.length===0){ cont.innerHTML = '<div class="small">Sin resultados.</div>'; return; }
  cont.innerHTML = prods.map(p => {
    const price = (p.price!=null? fmt(p.price): "S/ —");
    return `
      <div class="card" style="padding:10px;min-width:220px;flex:1">
        <div style="font-weight:700">${p.name}</div>
        <div class="small">SKU ${p.sku||"-"}</div>
        <div class="pill" style="margin-top:6px;display:inline-block">${price}</div>
        <div class="row" style="margin-top:8px;gap:6px;align-items:center">
          <button class="btn small tab" onclick="decQty('${p.id}')">−</button>
          <span id="qty-${p.id}" class="pill">0</span>
          <button class="btn small tab" onclick="incQty('${p.id}')">+</button>
          <button class="btn small add" style="margin-left:8px" onclick="addQtyToCart('${p.id}')">Añadir</button>
        </div>
      </div>`;
  }).join("");
}
const qtyBuffer = new Map();
function incQty(pid){ qtyBuffer.set(pid, (qtyBuffer.get(pid)||0)+1); S('#qty-'+pid).textContent = qtyBuffer.get(pid); }
function decQty(pid){ const v=(qtyBuffer.get(pid)||0)-1; qtyBuffer.set(pid, Math.max(0,v)); S('#qty-'+pid).textContent = qtyBuffer.get(pid); }

// ------------------ CARRITO / ENVÍO ------------------
function addQtyToCart(pid){
  const qty = qtyBuffer.get(pid)||0; if(qty<=0) return;
  const p = PRODUCTS.find(x=> x.id===pid);
  const idx = STATE.cart.findIndex(l => l.productId === pid);
  const price = p && p.price ? p.price : 0;
  if(idx>=0) STATE.cart[idx].qty += qty;
  else STATE.cart.push({ productId: pid, qty, price });
  qtyBuffer.set(pid,0); S('#qty-'+pid).textContent = 0;
  renderCart();
}
function removeLine(i){ STATE.cart.splice(i,1); renderCart(); }

async function submitSale(){
  if(STATE.cart.length===0){ alert("No hay productos en el carrito"); return; }
  if(!STATE.user?.advisorId){ alert("Vuelve a iniciar sesión"); return; }

  const payload = {
    advisorId: STATE.user.advisorId,
    region: STATE.user.regionName,
    local:  STATE.user.localName,
    date:   new Date().toISOString().slice(0,10),
    items:  STATE.cart.map(l => ({ productId: l.productId, qty: l.qty }))
  };

  // 1) Intentar guardar en la nube (Neon) vía Function
  let okCloud = false, saleId = null;
  try{
    const r = await fetch(`${API}/sale`, {
      method:'POST',
      headers:{'content-type':'application/json'},
      body: JSON.stringify(payload)
    }).then(x=>x.json());
    okCloud = !!(r && r.ok);
    saleId = r?.saleId || null;
  }catch(e){ okCloud = false; }

  // 2) Mantener histórico local (respaldo offline)
  const histKey = "reviderm_history_"+(STATE.user.dni||STATE.user.advisorId)+"_"+monthKey();
  STATE.history.push({
    id: saleId || crypto.randomUUID(),
    date: payload.date,
    items: STATE.cart.map(x => ({...x})),
    totalUnits: STATE.cart.reduce((a,l)=>a+l.qty,0),
    totalAmount: STATE.cart.reduce((a,l)=>a+l.qty*(l.price||0),0)
  });
  localStorage.setItem(histKey, JSON.stringify(STATE.history));
  STATE.cart = [];
  renderAll();

  alert(okCloud ? "Venta registrada (nube + local)" : "Venta registrada localmente (sin conexión). Se intentará sincronizar luego.");
}

function renderCart(){
  S("#cart-count").textContent = STATE.cart.length + " ítems";
  const list = S("#cart-list");
  if(STATE.cart.length===0){ list.innerHTML = '<div class="small">Añade productos para registrar la venta de hoy.</div>'; S("#cart-total").textContent = fmt(0); return; }
  list.innerHTML = STATE.cart.map((l,i)=>{
    const p = PRODUCTS.find(x=>x.id===l.productId);
    return `
      <div class="row card" style="padding:8px;align-items:center;justify-content:space-between">
        <div>
          <div style="font-weight:600)">${p?p.name:"?"}</div>
          <div class="small">SKU ${p?p.sku:""} · ${l.qty} <b>und.</b> · ${l.price?fmt(l.price):"S/ —"}</div>
        </div>
        <button class="btn small remove" onclick="removeLine(${i})">Quitar</button>
      </div>`;
  }).join("");
  const total = STATE.cart.reduce((a,l)=>a+l.qty*(l.price||0),0);
  S("#cart-total").textContent = fmt(total);
}

function renderHistory(){
  const cont = S("#history");
  if(STATE.history.length===0){ cont.innerHTML = ""; return; }
  cont.innerHTML = '<div class="title" style="font-size:16px">Historial reciente</div>' +
    STATE.history.slice().reverse().slice(0,5).map(h=>{
      return `
        <div class="row card" style="padding:8px;align-items:center;justify-content:space-between">
          <div>
            <div style="font-weight:600)">${h.date}</div>
            <div class="small">${h.items.length} líneas · ${h.totalUnits} <b>und.</b> · ${fmt(h.totalAmount)}</div>
          </div>
          <div class="pill" style="background:#ecfdf5;border-color:#bbf7d0;color:#065f46">✓ registrado</div>
        </div>`;
    }).join("");
}

// ------------------ PROGRESO (ahora desde el SERVIDOR) ------------------
async function renderProgress(){
  const goalLbl = S("#goal-label");
  const bar = S("#progress-bar");
  const ptxt = S("#progress-text");
  const rewardsList = S("#rewards-list");
  const nextLbl = S("#rewards-next");

  const month = monthKey();
  let units = 0, goal = 0, rewards = [];

  if(STATE.user?.advisorId){
    try{
      const q = new URLSearchParams({ advisorId: STATE.user.advisorId, month }).toString();
      const r = await fetch(`${API}/progress?${q}`).then(x=>x.json());
      if(r && r.ok){
        units = Number(r.unitsWeighted||0);
        goal  = Number(r.goal||0);
        rewards = r.rewards || [];
      }
    }catch(e){ /* fallback abajo */ }
  }

  // Fallback simple si no hay server: usa historial local
  if(!goal && !rewards.length){
    // Mantén meta por defecto si no tienes objetivos en servidor
    goal = 100;
  }

  const pct = goal ? Math.max(0, Math.min(100, Math.round((units/goal)*100))) : 0;
  goalLbl.textContent = `Objetivo mes: ${goal||0} unidades ponderadas`;
  bar.style.width = pct + "%";
  ptxt.textContent = `Llevas ${units} unidades ponderadas (${pct}%).`;

  // Pintar premios (usa estado que viene del servidor: past/current/future)
  rewardsList.innerHTML = (rewards.length? rewards : []).map(r=>{
    const money = r.value_pen!=null ? ' · '+new Intl.NumberFormat("es-PE",{style:"currency",currency:"PEN"}).format(r.value_pen) : '';
    const state = r.state || (units >= r.threshold ? 'past' : 'future');
    const cls = state==='current' ? 'reward current' : (state==='past' ? 'reward past' : 'reward future');
    return `<div class="${cls}"><div>${esc(r.label)}${money}</div><div class="small">${r.threshold} <b>und.</b></div></div>`;
  }).join("");

  // Mensaje "Te faltan…"
  let next = null;
  for(const r of (rewards || [])){ if(units < r.threshold){ next = r; break; } }
  if(next){
    nextLbl.innerHTML = `Te faltan ${(next.threshold-units)} <b>und.</b> para ${esc(next.label)}.`;
  }else{
    nextLbl.textContent = rewards.length ? "¡Alcanzaste el máximo nivel este mes!" : "";
  }
}

// ------------------ RENDER GENERAL ------------------
function renderAll(){ renderCategories(); renderProductButtons(); renderCart(); renderHistory(); renderProgress(); }

// ------------------ ARRANQUE ------------------
window.addEventListener("load", ()=>{
  if("serviceWorker" in navigator){ navigator.serviceWorker.register("./sw.js"); }
  initLogin();
  S("#btn-logout").onclick = logout;
  S("#btn-submit").onclick = submitSale;

  // Si quedó sesión guardada, volver a entrar
  try{
    const u = JSON.parse(localStorage.getItem("reviderm_user")||"null");
    if(u && u.advisorId){ STATE.user = u; enterApp(); }
  }catch{}
});
</script>
